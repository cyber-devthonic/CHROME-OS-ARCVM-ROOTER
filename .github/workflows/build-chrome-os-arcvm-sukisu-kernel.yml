name: Build Kernels

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: "Choose Release Type"
        required: true
        type: choice
        options:
          - Actions
          - Pre-Release
          - Release
        default: Actions
      build_selection:
        description: "Choose which kernels to build"
        required: true
        type: choice
        options:
          - All
          - Test Build
          - Android12-5.10
          - Android13-5.10
          - Android13-5.15
          - Android14-5.15
          - Android14-6.1
          - Android15-6.6
          - ARCVM
        default: All

jobs:

  build-test:
    if: inputs.build_selection == 'Test Build'
    uses: ./.github/workflows/test-build.yml
    secrets: inherit

  build-a12-5-10:
    if: (inputs.build_selection == 'All' || inputs.build_selection == 'Android12-5.10')
    uses: ./.github/workflows/kernel-a12-5-10.yml
    secrets: inherit

  build-a13-5-10:
    if: (inputs.build_selection == 'All' || inputs.build_selection == 'Android13-5.10')
    uses: ./.github/workflows/kernel-a13-5-10.yml
    secrets: inherit

  build-a13-5-15:
    if: (inputs.build_selection == 'All' || inputs.build_selection == 'Android13-5.15')
    uses: ./.github/workflows/kernel-a13-5-15.yml
    secrets: inherit

  build-a14-5-15:
    if: (inputs.build_selection == 'All' || inputs.build_selection == 'Android14-5.15')
    uses: ./.github/workflows/kernel-a14-5-15.yml
    secrets: inherit

  build-a14-6-1:
    if: (inputs.build_selection == 'All' || inputs.build_selection == 'Android14-6.1')
    uses: ./.github/workflows/kernel-a14-6-1.yml
    secrets: inherit

  build-a15-6-6:
    if: (inputs.build_selection == 'All' || inputs.build_selection == 'Android15-6.6')
    uses: ./.github/workflows/kernel-a15-6-6.yml
    secrets: inherit

  build-arcvm:
    if: (inputs.build_selection == 'All' || inputs.build_selection == 'ARCVM')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential libncurses-dev bison flex libssl-dev bc git zip

      - name: Set build directory
        run: |
          BUILD_DIR=$(pwd)/arcvm_build
          mkdir -p "$BUILD_DIR"
          echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV

      - name: Clone ChromeOS 5.10 ARCVM Kernel
        run: |
          cd "$BUILD_DIR"
          git clone --depth=1 https://chromium.googlesource.com/chromiumos/third_party/kernel.git -b chromeos-5.10-arcvm kernel_source
          cd kernel_source && git log -1 --oneline

      - name: Prepare kernel
        run: |
          KERNEL_DIR=$(find "$BUILD_DIR/kernel_source" -maxdepth 2 -type f -name Makefile -execdir test -d arch \; -print -quit)
          if [ -z "$KERNEL_DIR" ]; then
            echo "No kernel source found"
            exit 1
          fi
          echo "KERNEL_DIR=$KERNEL_DIR" >> $GITHUB_ENV
          cd "$KERNEL_DIR"
          make x86_64_defconfig
          scripts/config --enable CONFIG_KVM
          scripts/config --enable CONFIG_VIRTIO
          scripts/config --enable CONFIG_VHOST_NET

      - name: Build ARCVM kernel
        run: |
          cd "$KERNEL_DIR"
          make -j$(nproc) bzImage
          mkdir -p "$BUILD_DIR/artifacts"
          cp arch/x86/boot/bzImage "$BUILD_DIR/artifacts/arcvm-bzimage"

      - name: Upload ARCVM artifact
        uses: actions/upload-artifact@v5
        with:
          name: ARCVM-Kernel
          path: "$BUILD_DIR/artifacts/arcvm-bzimage"

  release:
    runs-on: ubuntu-latest
    if: inputs.release_type != 'Actions'
    needs:
      - build-a12-5-10
      - build-a13-5-10
      - build-a13-5-15
      - build-a14-5-15
      - build-a14-6-1
      - build-a15-6-6
      - build-arcvm
    env:
      GH_TOKEN: ${{ github.token }}
      RELEASE_NAME: "GKI & ARCVM Kernels v1.5.12"
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v5
        with:
          path: ./downloaded-artifacts

      - name: Generate New Tag
        run: |
          LATEST_TAG=$(gh api repos/${{ github.repository }}/tags --jq '.[0].name' 2>/dev/null || echo "v1.5.12-r0")
          NEW_TAG=$(echo "$LATEST_TAG" | awk -F'-r' '{suffix=$2; if (!suffix) suffix=0; suffix++; printf "%s-r%d", $1, suffix}')
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.NEW_TAG }}
          prerelease: ${{ inputs.release_type == 'Pre-Release' }}
          files: ./downloaded-artifacts/**
          name: ${{ env.RELEASE_NAME }}
          body: "All kernels built including ARCVM"

      - name: Send Telegram Notification
        run: |
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -F chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -F text="ðŸš€ New Kernel Release ${{ env.NEW_TAG }} uploaded! ðŸ”— https://github.com/${{ github.repository }}/releases/tag/${{ env.NEW_TAG }}"
